{% extends "main/base.html" %}

{% block scripts %}
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
        let columnForm= document.querySelectorAll(".column_form")
        let container = document.querySelector("#submit_form")
        let addButton = document.querySelector("#add_form")
        let totalForms = document.querySelector("#id_schemascolumn_set-TOTAL_FORMS")
        let newPosition = document.querySelector("#additional_columns")

        let formNum = columnForm.length-1
        addButton.addEventListener('click', addForm)

        function addForm(e){
            e.preventDefault()

            let newForm = columnForm[0].cloneNode(true)
            newForm.removeAttribute("hidden")
            let formRegex = RegExp(/_set-(\d)-/,'g')
            let columnType = document.querySelector("#id_category_type").value
            let columnName = document.querySelector("#id_category_type").value

            if (columnType === "integer"){
                deactivateElements(newForm, false)
            }
            else if (columnType === "text"){
                deactivateElements(newForm, true, false)
            }
            else {
                deactivateElements(newForm)
            }

            formNum++
            newForm.innerHTML = newForm.innerHTML.replace(formRegex, `_set-${formNum}-`)
            container.insertBefore(newForm, newPosition)

            totalForms.setAttribute('value', `${formNum+1}`)


        }

        function removeTemplateFormRequirements(){

        }

        function deactivateElements(newForm, integers = true, sentences = true){
            if (integers){
                newForm.querySelectorAll(".integer_type").forEach(element => element.closest("div").setAttribute("hidden", true))
            }
            if (sentences){
                newForm.querySelector(".sentence_type").closest("div").setAttribute("hidden", true)
            }
        }
    </script>

{% endblock %}

{% block body %}
    <form method="POST">
        <div class="d-flex justify-content-between">
            <div>
                 <h2>New Schema</h2>
              </div>
              <div>
                  <h2><button type="submit" name="submit_form" class="btn btn-primary">Submit</button></h2>
              </div>
        </div>
        {% csrf_token %}
        {% for field in form_new %}
            <div class="mb-3">
                <label class="form-label" for="{{ field.auto_id }}">{{ field.label }}</label>
                {{ field }}
                {% if field.errors %}
                    {% for error in field.errors %}
                        <div class="invalid-feedback invalid_feedback_modifier">
                        {{ error }}
                        </div>
                    {% endfor %}
                {% endif %}
            </div>
        {% endfor %}
        <div style="margin: 3em 0"  id="submit_form">
            <h2>Schema columns</h2>
            <!--Add new forms here-->
            {{ form_set.management_form }}
            {% for form in form_set.forms %}
                <div class="row mb-3 column_form" {% if forloop.counter0 == 0%}hidden{% endif %}>
                {% for field in form %}
                    {% if field.field.widget.input_type != "hidden" %}
                        {% if "order" in field.auto_id %}
                            <div class="col-sm-2">
                                <label class="form-label" for="{{ field.auto_id }}">{{ field.label }}</label>
                                {{ field }}
                            </div>
                        {% else %}
                            <div class="col-sm-3">
                                <label class="form-label" for="{{ field.auto_id }}">{{ field.label }}</label>
                                {{ field }}
                            </div>
                        {% endif %}
                    {% endif %}
                {% endfor %}
                </div>
            {% endfor %}
            <placement id="additional_columns"></placement>
        </div>
    </form>
    <form class="border-top add_column_form">
        <div class="row mb-3">
            {% for field in form_add_category %}
                {% if field.auto_id == "id_order" %}
                    <div class="col-sm-2">
                        <label class="form-label" for="{{ field.auto_id }}">{{ field.label }}</label>
                        {{ field }}
                    </div>
                {% else %}
                    <div class="col-sm-3">
                        <label class="form-label" for="{{ field.auto_id }}">{{ field.label }}</label>
                        {{ field }}
                    </div>
                {% endif %}
            {% endfor %}
        </div>
        <button type="submit" id="add_form" name="add_column" class="btn btn-primary add-row">Add Column</button>
    </form>
{% endblock %}